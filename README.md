# 增强版彩色目录树 (ctr)

这是一个功能强大的 Python 脚本，用于生成彩色的目录结构树或对目录内容进行深度分析。它提供了两种截然不同的工作模式：**目录树模式**用于可视化文件结构，**分析模式**则提供详细的诊断报告，解释为何某些文件被显示或隐藏。

其核心特性是基于 `.gitignore` 的自动忽略、强制摘要显示、高效计数以及一个清晰的三层优先级覆盖系统。

## ✨ 功能特性

*   **双模式操作**:
    *   **目录树模式 (默认)**: 生成美观的彩色目录树。
    *   **分析模式 (`--log`)**: 不生成树，而是输出一份关于顶层目录的详细分析报告。
*   **高效计数与显示上限**: 通过 `--max_count` 参数，可以为文件摘要设置一个计数上限（默认为 500）。这不仅能提升在含有海量文件目录下的扫描性能，还会用**醒目的红色**高亮显示已达到上限的摘要信息。
*   **彩色输出**: 使用 `colorama` 对目录和文件进行着色，输出清晰美观。
*   **智能忽略**:
    *   自动加载并应用当前目录下的 `.gitignore` 规则。
    *   当 `.gitignore` 不存在时，使用内置的常用忽略规则（如 `__pycache__`, `.git`, `node_modules` 等）。
*   **强制摘要**: 在目录树模式中，可以对特定目录（如 `data`, `logs`）强制以“摘要”模式显示，避免信息刷屏。
*   **强大的优先级系统**: 通过三层优先级规则，您可以精确控制每一个文件和目录的显示状态：
    1.  **最高优先级**: 命令行的 `-i` 参数，用于临时强制显示任何被忽略的项。
    2.  **次高优先级**: 脚本内硬编码的 `SPECIAL_HANDLING_RULES` 列表，用于定义项目的永久性特殊规则。
    3.  **最低优先级**: `.gitignore` 和内置忽略规则的组合。

## 🚀 安装与设置

为了在系统的任何路径下都能方便地使用 `ctr` 命令，请遵循以下步骤：

### 1. 先决条件

确保您的系统中已经安装了 Python 3 和 `colorama` 库。

```bash
pip install colorama
```

### 2. 放置文件

将您的脚本（例如 `tree.py`）和一个名为 `ctr.bat` 的批处理文件放置在同一个目录下，并将这个目录添加到系统的**环境变量 `PATH`** 中。

例如，您可以创建一个 `C:\bin` 目录，将文件放入其中，然后将 `C:\bin` 添加到 `PATH`。

**`ctr.bat`**

```batch
@echo off
python "%~dp0\tree.py" %*
```

这是一个批处理脚本，它的作用是调用 `tree.py` 并将所有命令行参数传递给它。

### 3. (可选) 为 Git Bash 设置别名

如果您经常使用 Git Bash，可以为其设置一个别名，以获得更好的使用体验。

```bash
# 将别名命令添加到你的 bash 配置文件中
echo "alias ctr='ctr.bat'" >> ~/.bashrc

# 使配置立即生效
source ~/.bashrc
```

## 🛠️ 使用方法

### 基本命令

```bash
ctr [path] [options]
```

*   `path`：要操作的目录路径。如果省略，默认为当前工作目录。

### 命令行选项

| 参数 | 说明 |
| :--- | :--- |
| `--log` | **【分析模式】** 不显示目录树，仅输出关于规则和顶层目录的详细分析报告。 |
| `-l`, `--level` | (仅目录树模式) 显示的目录层级深度，默认为 `5`。 |
| `-a`, `--all` | (仅目录树模式) 显示所有文件。此规则会被“强制摘要”规则覆盖。 |
| `-i`, `--include` | **(最高优先级)** 强制包含某个模式，使其可见并（在目录树模式中）进入摘要模式。可多次使用。 |
| `--max_count` | 设置文件摘要的计数和统计上限。达到上限的摘要将用**红色**标出。设为 `0` 可禁用此限制。默认为 `500`。 |

## ⚙️ 配置与过滤规则优先级

脚本的过滤行为由一个清晰的三级优先级系统决定：

### 🥇 优先级 1：`--include` / `-i` 参数 (最高)

这是最高级的规则，用于在命令行上进行**临时覆盖**。它会覆盖下面的所有规则。

*   任何匹配 `-i` 参数模式的项都将**强制可见**。
*   在目录树模式中，它还会**强制该项进入摘要模式**。

### 🥈 优先级 2：`SPECIAL_HANDLING_RULES` (次高)

这是在 `tree.py` 脚本内部定义的**项目级永久规则**。它是一个三元组列表，用于定义对特定文件夹的特殊处理。

```python
# 格式: (模式, 可见性, 强制摘要)
SPECIAL_HANDLING_RULES = [
    # ('data*', True, True) -> 匹配 'data' 开头的文件夹总是可见，且在树模式中总是摘要显示
    ('data*', True, True),
    # ('output*', False, False) -> 匹配 'output' 开头的文件夹总是被隐藏
    ('output*', False, False),
]
```

*   **可见性 (bool)**: `True` 表示可见，`False` 表示隐藏。
*   **强制摘要 (bool)**: `True` 表示在目录树模式下，该目录及其子目录总是以摘要模式显示，无视 `-a` 参数。

### 🥉 优先级 3：`.gitignore` 和内置规则 (最低)

如果一个项目没有被以上任何规则处理，脚本会最后检查这个忽略列表。

*   脚本会自动加载项目根目录下的 `.gitignore` 文件。
*   `.gitignore` 的规则会和脚本内置的 `BUILTIN_IGNORE_PATTERNS` 列表（包含 `**/__pycache__`, `.git` 等）合并，共同生效。

## 💡 使用示例

1.  **显示目录树**：
    *   这是默认模式，将美观地打印出目录结构。

    ```bash
    ctr -l 3
    ```

2.  **启动分析模式**：
    *   使用 `--log` 查看为何某些文件被显示或隐藏，而不打印目录树。

    ```bash
    ctr --log
    ```

3.  **临时查看被忽略的目录**：
    *   `.venv` 目录通常被忽略。使用 `-i` 可以临时在目录树中查看它（以摘要形式），或在分析报告中看到它的状态变为“可见”。

    ```bash
    # 在目录树中查看 .venv
    ctr -i .venv -l 2

    # 在分析报告中查看 .venv 的处理原因
    ctr --log -i .venv
    ```

4.  **控制文件计数上限**：
    *   在处理包含成千上万个同类型文件（如日志文件）的目录时，使用 `--max_count` 可以显著提升性能，并使输出更简洁。达到上限的摘要会以红色高亮显示。

    ```bash
    # 摘要中各类文件的数量最多显示为 "... (100 more ...)"
    ctr --max_count 100
    ```
