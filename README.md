# ctr - 增强版彩色目录树

`ctr` 是一个为开发者和命令行用户设计的、功能强大的 Python 脚本，用于生成彩色的目录结构树或对目录内容进行深度分析。它提供了两种截然不同的工作模式：**目录树模式**用于可视化文件结构，**分析模式**则提供详细的诊断报告，解释为何某些文件被显示或隐藏。

其核心特性是基于 `.gitignore` 的自动忽略、智能摘要显示、高效计数以及一个清晰的四级优先级覆盖系统。

## ✨ 功能特性

*   **双模式操作**:
    *   **目录树模式 (默认)**: 生成美观的彩色目录树，并自动在目录名后附加**子目录统计** `(N dirs)`。
    *   **分析模式 (`--log`)**: 不生成树，而是输出一份关于顶层目录的详细分析报告，清晰展示每个条目被哪条规则命中。
*   **智能摘要与显示**:
    *   **自动摘要**: 在默认模式下，当同一类型的兄弟文件超过一定数量（默认为5个）时，会自动折叠为摘要，保持输出的整洁。
    *   **强制摘要**: 可以对特定目录（如 `data`, `logs`）强制以“摘要”模式显示，即使在 `-a` 模式下也能避免信息刷屏。
*   **高效计数与显示上限**: 通过 `--max_count` 参数，可以为文件摘要设置一个计数上限（默认为 500）。这不仅能提升在含有海量文件目录下的扫描性能，还会用**醒目的红色**高亮显示已达到上限的摘要信息。
*   **智能忽略**:
    *   自动加载并应用当前目录下的 `.gitignore` 规则。
    *   内置强大且精简的忽略规则，如 `**/.*` 会自动忽略所有深度的“点文件”和“点目录”，同时也会处理 `__pycache__`, `node_modules` 等。
*   **强大的优先级系统**: 通过四级优先级规则，您可以精确控制每一个文件和目录的显示状态：
    1.  **最高优先级**: 命令行的 `-i`/`--include` 参数，用于临时强制显示任何被忽略的项。
    2.  **次高优先级**: 脚本内硬编码的 `SPECIAL_HANDLING_RULES` 列表，用于定义项目的永久性特殊规则。
    3.  **第三优先级**: `.gitignore` 和内置忽略规则的组合。
    4.  **最低优先级**: 默认可见。

## 🚀 安装与设置

为了在系统的任何路径下都能方便地使用 `ctr` 命令，请遵循以下步骤：

### 1. 先决条件

确保您的系统中已经安装了 Python 3 和 `colorama` 库。

```bash
pip install colorama
```

### 2. 放置文件

将您的脚本（`ctr.py`）和一个名为 `ctr.bat` 的批处理文件放置在同一个目录下，并将这个目录添加到系统的**环境变量 `PATH`** 中。

例如，您可以创建一个 `C:\bin` 目录，将文件放入其中，然后将 `C:\bin` 添加到 `PATH`。

**`ctr.bat`**

```batch
@echo off
python "%~dp0\ctr.py" %*
```

这是一个批处理脚本，它的作用是调用 `ctr.py` 并将所有命令行参数传递给它。

### 3. (可选) 为 Git Bash 设置别名

如果您经常使用 Git Bash，可以为其设置一个别名，以获得更好的使用体验。

```bash
# 将别名命令添加到你的 bash 配置文件中
echo "alias ctr='winpty ctr.bat'" >> ~/.bashrc

# 使配置立即生效
source ~/.bashrc
```

## 🛠️ 使用方法

### 基本命令

```bash
ctr [path] [options]
```

*   `path`：要操作的目录路径。如果省略，默认为当前工作目录。

### 命令行选项

| 参数 | 说明 |
| :--- | :--- |
| `--log` | **【分析模式】** 不显示目录树，仅输出关于规则和顶层目录的详细分析报告。 |
| `-l`, `--level` | (仅目录树模式) 显示的目录层级深度，默认为 `5`。 |
| `-a`, `--all` | (仅目录树模式) 显示所有文件。此规则会被“强制摘要”规则覆盖。 |
| `-i`, `--include` | **(最高优先级)** 强制包含一个或多个模式，使其可见并（在目录树模式中）进入摘要模式。**支持一次性提供多个值** (例如: `-i file.log *.tmp`)。 |
| `--max_count` | 设置文件摘要的**硬性统计上限**，同时也是 `-a` 模式下显示的样本上限。达到上限的摘要将用**红色**标出。设为 `0` 可禁用此限制。默认为 `500`。 |

## ⚙️ 配置与过滤规则优先级

脚本的过滤行为由一个清晰的四级优先级系统决定：

### 🥇 优先级 1：`--include` / `-i` 参数 (最高)

这是最高级的规则，用于在命令行上进行**临时覆盖**。它会覆盖下面的所有规则。

*   任何匹配 `-i` 参数模式的项都将**强制可见**。
*   在目录树模式中，它还会**强制该项进入摘要模式**。

**新用法**: 您可以一次性提供多个模式。
```bash
ctr -i .env package-lock.json
```

### 🥈 优先级 2：`SPECIAL_HANDLING_RULES` (次高)

这是在 `ctr.py` 脚本内部定义的**项目级永久规则**。它是一个三元组列表，用于定义对特定文件夹的特殊处理。

```python
# 格式: (模式, 可见性, 强制摘要)
SPECIAL_HANDLING_RULES = [
    # ('data*', True, True) -> 'data'开头的文件夹总是可见，且总是摘要显示
    ('data*', True, True),
    # ('output*', False, False) -> 'output'开头的文件夹总是被隐藏
    ('output*', False, False),
]
```

*   **可见性 (bool)**: `True` 表示可见，`False` 表示隐藏。
*   **强制摘要 (bool)**: `True` 表示在目录树模式下，该目录及其子目录总是以摘要模式显示，无视 `-a` 参数。

### 🥉 优先级 3：`.gitignore` 和内置规则

如果一个项目没有被以上任何规则处理，脚本会最后检查这个忽略列表。

*   脚本会自动加载项目根目录下的 `.gitignore` 文件。
*   `.gitignore` 的规则会和脚本内置的 `BUILTIN_IGNORE_PATTERNS` 列表（包含 `**/.*`, `**/__pycache__` 等）合并，共同生效。

### 🏅 优先级 4：默认行为 (最低)

任何未被上述规则命中的项目，默认都是**可见的**。

## 💡 使用示例

1.  **显示3层目录树**：
    *   默认模式会自动摘要包含大量文件的目录，并显示子目录统计。

    ```bash
    ctr -l 3
    ```

2.  **启动分析模式**：
    *   使用 `--log` 查看为何某些文件被显示或隐藏，而不打印目录树。

    ```bash
    ctr --log
    ```

3.  **临时查看被忽略的项**：
    *   `.venv` 目录通常被 `**/.*` 规则忽略。使用 `-i` 可以临时在目录树中查看它（以摘要形式），或在分析报告中看到它的状态变为“可见”。

    ```bash
    # 在目录树中查看 .venv 和 .gitignore
    ctr -i .venv .gitignore -l 2

    # 在分析报告中查看它们的处理原因
    ctr --log -i .venv .gitignore
    ```

4.  **控制文件计数上限**：
    *   在处理包含成千上万个同类型文件的目录时，使用 `--max_count` 可以显著提升性能，并使输出更简洁。

    ```bash
    # 摘要中各类文件的数量最多统计到100个，超过则显示为 "... (N+ more ...)"
    # 达到上限的摘要会以红色高亮显示
    ctr --max_count 100
    ```
